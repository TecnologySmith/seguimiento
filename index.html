<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Clientes - Seguimiento</title>
    <style>
        /* ESTILOS - Reemplaza estos colores con los de tu desarrollo anterior */
        :root {
            --primary-color: #4A90E2; /* Color principal */
            --secondary-color: #f5f5f5;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }

        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .full-width { grid-column: span 2; }

        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        textarea, input[type="text"], input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        textarea { height: 120px; }

        .topic-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #e0e0e0;
            transition: background 0.3s;
        }

        button.active {
            background-color: var(--primary-color);
            color: white;
        }

        button#btnGuardar {
            background-color: #28a745;
            color: white;
            font-size: 1.1em;
            width: 100%;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th { background-color: var(--primary-color); color: white; }
        
        /* Feedback visual */
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ingreso de Información</h2>
    
    <div class="form-section">
        <div>
            <label>Información del Cliente (Pegar formato):</label>
            <textarea id="rawInfo" placeholder="Pega aquí la información..."></textarea>
        </div>

        <div>
            <label>Fecha de Reunión:</label>
            <input type="date" id="meetingDate">

            <label style="margin-top: 15px;">Tema de Capacitación:</label>
            <div class="topic-selector">
                <button type="button" onclick="selectTopic('Primera capacitación', this)">Primera capacitación</button>
                <button type="button" onclick="selectTopic('Segunda capacitación', this)">Segunda capacitación</button>
                <input type="text" id="otherTopic" placeholder="Otra capacitación..." oninput="clearButtons()">
            </div>

            <label style="margin-top: 15px;">Fecha de Seguimiento (Próximo Martes):</label>
            <input type="date" id="followUpDate">
            
            <label style="margin-top: 15px;">Notas:</label>
            <input type="text" id="notes" placeholder="Notas adicionales...">
        </div>
    </div>

    <button id="btnGuardar" onclick="processAndSave()">Agregar a la Tabla y Guardar en Drive</button>

    <h2>Tabla de Registros</h2>
    <table id="resultTable">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Empresa</th>
                <th>Email</th>
                <th>Número</th>
                <th>Fecha Reunión</th>
                <th>Tema</th>
                <th>Próximo Seguimiento</th>
                <th>Notas</th> </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    // --- CONFIGURACIÓN ---
    // ¡IMPORTANTE! PEGA AQUÍ LA URL DE TU WEB APP DE APPS SCRIPT
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzs0wkU4sxWSYZYEAsCNMcZeJVMaf2E8bxRJNVlwbgsdJMW0VbLUVTp77wHP_AXNSny/exec'; 

    // --- INICIALIZACIÓN ---
    window.onload = function() {
        setTodayDate();
        setNextTuesday();
    };

    // Establecer fecha de hoy por defecto
    function setTodayDate() {
        const today = new Date();
        document.getElementById('meetingDate').valueAsDate = today;
    }

    // Calcular y establecer el próximo martes
    function setNextTuesday() {
        const d = new Date();
        const day = d.getDay();
        // 0=Domingo, 1=Lunes, 2=Martes...
        // Calcular días hasta el próximo martes (2)
        let diff = 2 - day;
        if (diff <= 0) diff += 7; // Si es martes o después, ir al siguiente
        d.setDate(d.getDate() + diff);
        document.getElementById('followUpDate').valueAsDate = d;
    }

    // Lógica de botones de tema
    let selectedTopic = "";

    function selectTopic(topic, btnElement) {
        selectedTopic = topic;
        document.getElementById('otherTopic').value = ""; // Limpiar campo de texto
        
        // Visual updates
        document.querySelectorAll('.topic-selector button').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
    }

    function clearButtons() {
        selectedTopic = "";
        document.querySelectorAll('.topic-selector button').forEach(b => b.classList.remove('active'));
    }

    // --- PROCESAMIENTO PRINCIPAL ---
    function processAndSave() {
        const rawText = document.getElementById('rawInfo').value.trim();
        if (!rawText) { alert("Por favor pega la información del cliente"); return; }

        const lines = rawText.split('\n').map(line => line.trim()).filter(line => line !== '');

        // Extracción segura de datos (evita errores si faltan líneas)
        const nombre = lines[0] || "";
        // Remover 'label_important' del inicio de la empresa
        const empresa = (lines[1] || "").replace(/^label_important/, '').trim();
        const email = lines[2] || "";
        const numero = lines[3] || "";

        // Obtener otros campos
        const fechaReunion = document.getElementById('meetingDate').value;
        const temaFinal = document.getElementById('otherTopic').value || selectedTopic || "Sin tema";
        const fechaSeguimiento = document.getElementById('followUpDate').value;
        const notas = document.getElementById('notes').value;

        // Crear objeto de datos
        const rowData = {
            nombre,
            empresa,
            email,
            numero,
            fechaReunion,
            tema: temaFinal,
            proximoSeguimiento: fechaSeguimiento,
            notas
        };

        // 1. Agregar a la Tabla Visual (HTML)
        addToTable(rowData);

        // 2. Guardar en Google Sheets
        saveToGoogleSheets(rowData);
    }

    function addToTable(data) {
        const table = document.getElementById('resultTable').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        
        Object.values(data).forEach(text => {
            const cell = newRow.insertCell();
            cell.textContent = text;
        });
    }

    function saveToGoogleSheets(data) {
        if (SCRIPT_URL === 'TU_URL_DE_APPS_SCRIPT_AQUI') {
            alert("Datos mostrados en tabla, pero NO guardados en Drive.\n\nFalta configurar la URL del Apps Script en el código.");
            return;
        }

        const btn = document.getElementById('btnGuardar');
        const originalText = btn.innerText;
        btn.innerText = "Guardando...";
        btn.classList.add('loading');

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Necesario para Apps Script
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(() => {
            alert("¡Guardado exitosamente en la hoja de cálculo!");
            // Opcional: Limpiar campos
            // document.getElementById('rawInfo').value = "";
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error al guardar en Drive.");
        })
        .finally(() => {
            btn.innerText = originalText;
            btn.classList.remove('loading');
        });
    }
</script>

</body>
</html>